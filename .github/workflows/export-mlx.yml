name: Auto-export MATLAB Live Scripts

on:
  push:
    paths:
      - '**/*.mlx'
  pull_request:
    paths:
      - '**/*.mlx'
  workflow_dispatch:

jobs:
  export-matlab:
    runs-on: windows-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4

      # Step 2: Set up MATLAB
      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2

      # Step 3: Detect changed .mlx files
      - name: Get changed .mlx files
        id: changed-files
        shell: bash
        run: |
          echo "::group::Changed .mlx files"
          CHANGED=$(git diff --name-only ${{ github.sha }} ${{ github.sha }}~1 | grep '\.mlx$' || echo "")
          echo "Changed .mlx files:"
          echo "$CHANGED"
          echo "::endgroup::"
          # Export list of files as workflow output
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Step 4: Export changed .mlx files to HTML
      - name: Export changed .mlx files
        if: steps.changed-files.outputs.files != ''
        run: |
          matlab -batch "
          files = strsplit(getenv('CHANGED_FILES'), char(10));
          outputDir = 'docs';
          if ~exist(outputDir,'dir'), mkdir(outputDir); end
          for k = 1:numel(files)
              f = strtrim(files{k});
              if isempty(f), continue; end
              [~, name] = fileparts(f);
              outFile = fullfile(outputDir, name + '.html');
              export(f, outFile);
          end
          "
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.files }}

      # Step 5: Commit updated HTML files
      - name: Commit and push HTML
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add docs/*.html
          git diff --quiet && echo "No changes to commit" || git commit -m "Auto-export updated .mlx files to HTML"
          git push
