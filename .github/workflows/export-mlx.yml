name: Auto-export MEC3079S Live Scripts

on:
  push:
    paths:
      - '**/*.mlx'
  workflow_dispatch:

env:
  MLM_LICENSE_TOKEN: ${{ secrets.MLM_LICENSE_TOKEN }}

jobs:
  export-matlab:
    runs-on: windows-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2024b

      - name: Verify MATLAB License
        uses: matlab-actions/run-command@v2
        with:
          command: |
            disp(version)
            assert(license('test','MATLAB') == 1)

      - name: Export MEC3079S .mlx files to HTML and PDF
        uses: matlab-actions/run-command@v2
        with:
          command: |
            % Find only MEC3079S*.mlx files recursively
            files = dir('**/MEC3079S*.mlx');

            htmlDir = fullfile('Notes','HTML Exports');
            pdfDir  = fullfile('Notes','PDF Exports');

            if ~exist(htmlDir,'dir')
                mkdir(htmlDir);
            end

            if ~exist(pdfDir,'dir')
                mkdir(pdfDir);
            end

            for k = 1:numel(files)
                f = fullfile(files(k).folder, files(k).name);
                [~, name] = fileparts(f);

                % Export HTML
                export(f, fullfile(htmlDir, name + ".html"));

                % Export PDF
                export(f, fullfile(pdfDir, name + ".pdf"));
            end

      - name: Commit and push HTML and PDF exports
        shell: bash
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add "Notes/HTML Exports" "Notes/PDF Exports" || true

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-export MEC3079S Live Scripts to HTML and PDF"
            git push
          fi
